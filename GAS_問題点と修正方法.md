# GASコードの問題点と修正方法

## 主な問題点

### 1. **configシートの読み込み問題**
#### 問題
- スプレッドシートの値が数値やDateオブジェクトとして読み込まれる可能性がある
- 空白行や空のキーが含まれている場合の処理が不十分
- エラーログがないため、何が読み込めているか分からない

#### 修正内容
- 値を明示的に文字列に変換
- Dateオブジェクトの場合は適切な形式に変換
- 各設定項目の読み込み状況をログ出力

### 2. **GitHub API認証の問題**
#### 問題
- `Authorization: token ` という形式が古い可能性（現在は `Bearer` が推奨）
- APIバージョンヘッダーが指定されていない
- エラーレスポンスの詳細が取得できていない

#### 修正内容
- `Authorization: Bearer ` に変更（GitHub API推奨形式）
- `X-GitHub-Api-Version` ヘッダーを追加
- エラーレスポンスを詳細に解析してログ出力

### 3. **日付・時間の解析問題**
#### 問題
- スプレッドシートから取得した日付がDateオブジェクトの場合、文字列変換が必要
- タイムゾーンの問題
- 日時解析が失敗した場合の詳細ログがない

#### 修正内容
- Dateオブジェクトの場合は適切な形式（yyyy-MM-dd, HH:mm）に変換
- 日時解析失敗時には詳細なログを出力
- 現在時刻と投稿予定時刻を比較する際のログを追加

### 4. **デバッグ情報の不足**
#### 問題
- エラーが発生しても原因が特定できない
- configシートの読み込み状況が分からない
- 処理の流れが見えない

#### 修正内容
- 各処理段階で詳細なログを追加
- `debugCheck()` 関数を追加（設定とpostsシートの状態を確認）
- エラー時にエラーメッセージを詳細に出力

## 確認すべきポイント

### configシートの設定

以下の項目が正しく設定されているか確認してください：

```
github_repo: <ユーザー名>/<リポジトリ名> (例: canly/x-auto-post)
github_token: GitHub Personal Access Token (repoスコープが必要)
slack_webhook_url: Slack Webhook URL (任意)
drive_folder_id: Google DriveフォルダID (任意)
```

### GitHub Personal Access Tokenの権限

以下のスコープが必要です：
- `repo` (リポジトリへのフルアクセス)

### postsシートの形式

以下の列構成で、ヘッダー行が必要です：

| 列 | 内容 | 形式 |
|---|---|---|
| A | 日付 | YYYY-MM-DD または 日付形式 |
| B | 時間 | HH:mm または 時間形式 |
| C | テキスト | 投稿本文 |
| D | 画像 | Google DriveファイルID または URL |
| E | 投稿済みフラグ | TRUE/FALSE または '投稿済' |
| F | Slackメッセージ | Webhook URL (任意) |

## デバッグ手順

1. **`debugCheck()` 関数を実行**
   - メニューから実行、またはスクリプトエディタで実行
   - 実行ログを確認（表示 > 実行ログ）

2. **`getConfig()` 関数を実行**
   - 設定が正しく読み込まれているか確認

3. **`autoCheckPosts()` 関数を手動実行**
   - 各処理段階のログを確認
   - エラーが発生している箇所を特定

4. **実行ログの確認**
   - スクリプトエディタで「表示 > 実行ログ」を開く
   - 各ログメッセージを確認

## よくあるエラーと対処法

### エラー: "GitHub dispatch failed. HTTP 401"
- **原因**: GitHubトークンが無効または権限不足
- **対処**: Personal Access Tokenを再作成し、`repo`スコープを付与

### エラー: "GitHub dispatch failed. HTTP 404"
- **原因**: リポジトリ名が間違っている、またはリポジトリへのアクセス権がない
- **対処**: `github_repo` の形式を `<ユーザー名>/<リポジトリ名>` で確認

### エラー: "日時解析失敗"
- **原因**: 日付・時間の形式が期待と異なる
- **対処**: postsシートのA列（日付）とB列（時間）の形式を確認

### configが読み込めない
- **原因**: configシートが存在しない、または形式が正しくない
- **対処**: 
  - configシートが存在するか確認
  - A列にキー、B列に値を設定
  - 空白行がないか確認

